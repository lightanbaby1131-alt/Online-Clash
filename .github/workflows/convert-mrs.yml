name: Convert LIST to MRS

on:
  schedule:
    - cron: "10 22 * * *"   # 每天 UTC 时间 22:10 → 中国时间 06:10
  workflow_dispatch:
  push:
    paths:
      - "Rule/list/*.list"
      - "Rule/temp/*.list"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p .github/temp
          mkdir -p Rule/mrs

      - name: Clean old MRS files
        run: |
          rm -f Rule/mrs/*.mrs || true

      - name: Download latest Mihomo (with fallback)
        run: |
          API_JSON=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)

          # 1. Try v3-go120
          LATEST_URL=$(echo "$API_JSON" \
            | grep "browser_download_url" \
            | grep "linux-amd64-v3-go120" \
            | grep ".gz" \
            | head -n 1 \
            | cut -d '"' -f 4)

          # 2. Try v3-go123
          if [ -z "$LATEST_URL" ]; then
            LATEST_URL=$(echo "$API_JSON" \
              | grep "browser_download_url" \
              | grep "linux-amd64-v3-go123" \
              | grep ".gz" \
              | head -n 1 \
              | cut -d '"' -f 4)
          fi

          # 3. Try any v3
          if [ -z "$LATEST_URL" ]; then
            LATEST_URL=$(echo "$API_JSON" \
              | grep "browser_download_url" \
              | grep "linux-amd64-v3" \
              | grep ".gz" \
              | head -n 1 \
              | cut -d '"' -f 4)
          fi

          echo "Downloading Mihomo from: $LATEST_URL"
          wget -O .github/temp/mihomo.gz "$LATEST_URL"

          echo "Extracting Mihomo..."
          gunzip .github/temp/mihomo.gz
          chmod +x .github/temp/mihomo

      - name: Convert all .list to .mrs
        run: |
          for file in Rule/list/*.list Rule/temp/*.list; do
            if [ -f "$file" ]; then
              name=$(basename "$file" .list)
              echo "Converting $file → Rule/mrs/$name.mrs"
              .github/temp/mihomo convert-ruleset domain text "$file" "Rule/mrs/$name.mrs"
            fi
          done

      - name: Commit changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add Rule/mrs/*.mrs
          git commit -m "Auto-update MRS rulesets" || echo "No changes to commit"

      - name: Push changes
        uses: ad-m/github-push-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
