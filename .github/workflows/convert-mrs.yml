name: Convert LIST to MRS

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    paths:
      - "Rule/temp/*.list"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p .github/temp
          mkdir -p Rule/mrs

      - name: Clean old MRS files
        run: |
          echo "Cleaning old .mrs files..."
          rm -f Rule/mrs/*.mrs || true

      - name: Download latest Mihomo v3 binary
        run: |
          LATEST_URL=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest \
            | grep "browser_download_url" \
            | grep "linux-amd64-v3" \
            | grep ".gz" \
            | cut -d '"' -f 4)

          echo "Downloading Mihomo from: $LATEST_URL"
          wget -O .github/temp/mihomo.gz "$LATEST_URL"

          echo "Extracting Mihomo..."
          gunzip .github/temp/mihomo.gz
          chmod +x .github/temp/mihomo

      - name: Convert all .list to .mrs
        run: |
          for file in Rule/temp/*.list; do
            name=$(basename "$file" .list)
            echo "Converting $file â†’ Rule/mrs/$name.mrs"
            .github/temp/mihomo convert-ruleset domain text "$file" "Rule/mrs/$name.mrs"
          done

      - name: Commit changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add Rule/mrs/*.mrs
          git commit -m "Auto-update MRS rulesets" || echo "No changes to commit"

      - name: Push changes
        uses: ad-m/github-push-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
